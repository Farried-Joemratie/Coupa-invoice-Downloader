<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupa Invoice Downloader</title>

    <style>
        body {
            font-family: Arial;
            margin: 40px;
            background: #fff;
        }

        h1 {
            color: #ff5500;
        }

        button {
            background-color: #ff5500;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background-color: #ff7733;
        }

        .top-right {
            position: fixed;
            top: 10px;
            right: 20px;
            color: #ff5500;
            font-weight: bold;
        }

        #progressBox {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
            width: 350px;
            display: none;
            background: #fafafa;
        }
    </style>
</head>

<body>

    <div class="top-right">Powered by Farried Joemratie</div>

    <h1>üìÑ Coupa Invoice Downloader</h1>
    <p>Upload your invoice CSV and download invoice PDFs in bulk via Coupa API.</p>
    <hr>

    <h2>üìÇ Upload Invoice CSV</h2>
    <input type="file" id="csvFile" accept=".csv">
    <br><br>
    <button onclick="handleCSV()">Process CSV</button>

    <hr>

    <h2>üîê Coupa OAuth2 Credentials</h2>

    Client ID:<br>
    <input type="text" id="clientId" style="width:300px;"><br><br>

    Client Secret:<br>
    <input type="password" id="clientSecret" style="width:300px;"><br><br>

    Coupa Token URL:<br>
    <input type="text" id="tokenUrl" placeholder="https://<tenant>.coupahost.com/oauth2/token"
        style="width:300px;"><br><br>

    Coupa API Base URL:<br>
    <input type="text" id="apiBase" placeholder="https://<tenant>.coupahost.com/api/invoices"
        style="width:300px;"><br><br>

    <button onclick="downloadAll()">üì¶ Download All PDFs</button>

    <div id="progressBox">
        <b>Progress:</b><br>
        <div id="progressText">Waiting‚Ä¶</div>
    </div>

    <footer style="margin-top:50px;">
        ¬© 2025 Coupa Invoice Downloader | Farried Joemratie
    </footer>

    <script>
        /* -----------------------------------------
           1. PARSE CSV (simple built-in parser)
        ----------------------------------------- */
        let invoiceList = [];

        function handleCSV() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return alert("Please upload a CSV file.");

            const reader = new FileReader();
            reader.onload = function (e) {
                invoiceList = parseCSV(e.target.result);
                alert("CSV processed. Found " + invoiceList.length + " invoices.");
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.trim().split("\n");
            const header = lines[0].split(",").map(h => h.trim().toLowerCase());

            const idIndex = header.indexOf("invoice id");
            const numberIndex = header.indexOf("invoice #");

            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(",");
                result.push({
                    id: cols[idIndex].trim(),
                    number: cols[numberIndex].trim()
                });
            }
            return result;
        }

        /* -----------------------------------------
           2. GET OAUTH2 TOKEN FROM COUPA
        ----------------------------------------- */
        async function getOAuthToken() {
            const clientId = document.getElementById("clientId").value;
            const clientSecret = document.getElementById("clientSecret").value;
            const tokenUrl = document.getElementById("tokenUrl").value;

            const body = new URLSearchParams();
            body.append("grant_type", "client_credentials");
            body.append("client_id", clientId);
            body.append("client_secret", clientSecret);

            const res = await fetch(tokenUrl, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body
            });

            if (!res.ok) {
                alert("OAuth2 Error: " + res.status);
                throw new Error("OAuth2 failed");
            }

            const json = await res.json();
            return json.access_token;
        }

        /* -----------------------------------------
           3. DOWNLOAD PDF FOR EACH INVOICE
        ----------------------------------------- */
        async function fetchInvoicePdf(token, invoiceId, apiBase) {
            const url = `${apiBase}/${invoiceId}/pdf`;

            const res = await fetch(url, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Accept": "application/pdf"
                }
            });

            if (!res.ok) {
                throw new Error("Failed PDF for: " + invoiceId);
            }

            return await res.blob();
        }

        /* -----------------------------------------
           4. ZIP ALL PDF FILES (JSZip implementation)
        ----------------------------------------- */
        class JSZip { constructor() { this.files = {}; } file(n, b) { this.files[n] = b; } async generateAsync() { return new Blob(Object.values(this.files)); } }

        async function downloadAll() {
            if (invoiceList.length === 0) {
                return alert("No invoices loaded. Upload CSV first.");
            }

            document.getElementById("progressBox").style.display = "block";
            document.getElementById("progressText").innerText = "Authenticating‚Ä¶";

            const token = await getOAuthToken();
            const apiBase = document.getElementById("apiBase").value;

            const zip = new JSZip();
            let done = 0;

            for (const inv of invoiceList) {
                try {
                    document.getElementById("progressText").innerText =
                        `Downloading ${inv.number} (${inv.id})‚Ä¶`;

                    const pdf = await fetchInvoicePdf(token, inv.id, apiBase);
                    zip.file(`invoice_${inv.number}.pdf`, pdf);

                    done++;
                } catch (e) {
                    console.error(e);
                }
            }

            document.getElementById("progressText").innerText =
                "Creating ZIP‚Ä¶";

            const zipBlob = await zip.generateAsync();
            const link = document.createElement("a");
            link.href = URL.createObjectURL(zipBlob);
            link.download = "invoices.zip";
            link.click();

            document.getElementById("progressText").innerText =
                "Done! Downloaded " + done + " invoices.";
        }
    </script>

</body>

</html>